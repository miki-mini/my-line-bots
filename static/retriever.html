<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Watchdog Retriever - æ™‚é–“ã¨å¥åº·ã®ã‚¬ã‚¤ãƒ‰</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&family=Outfit:wght@400;600&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --primary-color: #8D6E63;
            /* Warm Brown */
            --secondary-color: #D7CCC8;
            /* Light Brown */
            --accent-color: #FF7043;
            /* Warm Orange */
            --bg-color: #F5F5F5;
            --card-bg: #FFFFFF;
            --text-main: #3E2723;
            --text-sub: #5D4037;
            --shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
            --radius: 20px;
        }

        body {
            font-family: 'Outfit', 'Noto Sans JP', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            padding: 0;
            line-height: 1.6;
        }

        header {
            background-color: var(--card-bg);
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        h1 {
            margin: 0;
            font-size: 1.5rem;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        main {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        .card {
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: 30px;
            margin-bottom: 25px;
            box-shadow: var(--shadow);
            transition: transform 0.3s ease;
        }

        .card:hover {
            transform: translateY(-2px);
        }

        h2 {
            font-size: 1.25rem;
            margin-top: 0;
            margin-bottom: 20px;
            color: var(--text-sub);
            border-left: 4px solid var(--primary-color);
            padding-left: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-sub);
        }

        select,
        input[type="number"] {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--secondary-color);
            border-radius: 12px;
            font-size: 1rem;
            font-family: inherit;
            background: #FAFAFA;
            transition: border-color 0.3s;
            box-sizing: border-box;
        }

        select:focus,
        input[type="number"]:focus {
            border-color: var(--primary-color);
            outline: none;
            background: #FFF;
        }

        .btn-primary {
            display: block;
            width: 100%;
            padding: 15px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s, transform 0.1s;
        }

        .btn-primary:hover {
            background: #6D4C41;
        }

        .btn-primary:active {
            transform: scale(0.98);
        }

        /* Result Section */
        #result-section {
            display: none;
            animation: fadeIn 0.5s ease;
        }

        .age-display {
            text-align: center;
            margin: 20px 0;
        }

        .human-age-label {
            font-size: 1rem;
            color: var(--text-sub);
        }

        .human-age-value {
            font-size: 3rem;
            font-weight: 700;
            color: var(--primary-color);
        }

        .stage-badge {
            display: inline-block;
            background: var(--secondary-color);
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-main);
            margin-bottom: 10px;
        }

        .advice-box {
            background: #EFEBE9;
            padding: 20px;
            border-radius: 12px;
            margin-top: 20px;
        }

        .advice-title {
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 10px;
            display: block;
        }

        /* Chart Concept */
        .chart-container {
            position: relative;
            height: 60px;
            background: #E0E0E0;
            border-radius: 30px;
            margin: 30px 0;
            overflow: hidden;
        }

        .chart-bar {
            height: 100%;
            background: linear-gradient(to right, #FFCCBC, #FF7043);
            width: 0%;
            transition: width 1s ease-out;
            border-radius: 30px;
        }

        .chart-marker {
            position: absolute;
            top: 0;
            bottom: 0;
            border-right: 2px dashed rgba(255, 255, 255, 0.5);
            color: rgba(0, 0, 0, 0.5);
            font-size: 0.8rem;
            padding-top: 5px;
            padding-right: 5px;
            text-align: right;
        }

        /* Photo Overlay */
        .overlay-container {
            text-align: center;
            position: relative;
            max-width: 400px;
            margin: 0 auto;
        }

        #photo-canvas {
            width: 100%;
            border-radius: 12px;
            background: #eee;
            min-height: 200px;
        }

        input[type="file"] {
            display: none;
        }

        .file-upload-btn {
            display: inline-block;
            padding: 10px 20px;
            background: var(--secondary-color);
            color: var(--text-main);
            border-radius: 8px;
            cursor: pointer;
            margin-bottom: 15px;
            font-weight: 500;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @media (max-width: 600px) {
            .human-age-value {
                font-size: 2.5rem;
            }
        }
    </style>
</head>

<body>

    <header>
        <h1>ğŸ• Watchdog Retriever</h1>
    </header>

    <main>
        <div class="card">
            <h2>ãƒšãƒƒãƒˆã®å¹´é½¢ã‚’çŸ¥ã‚‹</h2>
            <div class="form-group">
                <label>ç¨®é¡</label>
                <select id="animal-type">
                    <option value="dog_small">å°å‹çŠ¬ (ã€œ10kg)</option>
                    <option value="dog_medium">ä¸­å‹çŠ¬ (10ã€œ25kg)</option>
                    <option value="dog_large">å¤§å‹çŠ¬ (25kgã€œ)</option>
                    <option value="cat">çŒ«</option>
                    <option value="rabbit">ã†ã•ã</option>
                    <option value="hamster">ãƒãƒ ã‚¹ã‚¿ãƒ¼ãƒ»å°å‹•ç‰©</option>
                    <option value="bird_small">å°é³¥ (ã‚¤ãƒ³ã‚³ç­‰)</option>
                    <option value="bird_medium">ä¸­å‹é³¥ (ã‚ªã‚«ãƒ¡ç­‰)</option>
                    <option value="bird_large">å¤§å‹é³¥ (ã‚ªã‚¦ãƒ ç­‰)</option>
                </select>
            </div>
            <div class="form-group" style="display: flex; gap: 10px;">
                <div style="flex: 1;">
                    <label>å¹´é½¢ (æ­³)</label>
                    <input type="number" id="animal-age-years" min="0" max="100" value="1">
                </div>
                <div style="flex: 1;">
                    <label>ãƒ¶æœˆ</label>
                    <input type="number" id="animal-age-months" min="0" max="11" value="0">
                </div>
            </div>
            <button class="btn-primary" onclick="calculateAge()">è¨ºæ–­ã™ã‚‹</button>
        </div>

        <div id="result-section">
            <div class="card">
                <div class="age-display">
                    <span class="stage-badge" id="result-stage">Adult</span>
                    <div class="human-age-label">äººé–“å¹´é½¢ã«æ›ç®—ã™ã‚‹ã¨...</div>
                    <div class="human-age-value"><span id="human-age-num">--</span> æ­³</div>
                </div>

                <div class="chart-container">
                    <div class="chart-bar" id="life-bar"></div>
                    <!-- Concept Markers -->
                    <div class="chart-marker" style="left: 20%">æˆäºº</div>
                    <div class="chart-marker" style="left: 60%">é‚„æš¦</div>
                </div>

                <div class="advice-box">
                    <span class="advice-title" id="advice-title">ã‚¢ãƒ‰ãƒã‚¤ã‚¹</span>
                    <p id="advice-text">...</p>
                    <span class="advice-title" style="margin-top:15px; font-size: 0.9rem;">ğŸ¥ å¥åº·ãƒã‚§ãƒƒã‚¯</span>
                    <p id="checkup-text" style="font-size: 0.9rem;">...</p>
                </div>
            </div>

            <div class="card">
                <h2>ğŸ“· è¨˜å¿µãƒ•ã‚©ãƒˆ</h2>
                <p style="font-size: 0.9rem; margin-bottom: 15px;">å†™çœŸã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã¨ã€å¹´é½¢ã«åˆã‚ã›ãŸã‚¹ã‚¿ãƒ³ãƒ—ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚</p>
                <div class="overlay-container">
                    <label for="photo-input" class="file-upload-btn">å†™çœŸã‚’é¸æŠ</label>
                    <input type="file" id="photo-input" accept="image/*" onchange="handleImageUpload(event)">
                    <canvas id="photo-canvas"></canvas>
                </div>
            </div>
        </div>

        <div class="card" style="text-align: center; overflow: hidden; padding: 0;">
            <img src="../animals/images/retriever_chart.jpg" alt="Life Stage Chart"
                style="width: 100%; height: auto; display: block;">
            <div style="padding: 20px;">
                <h3 style="margin-top: 0; color: var(--primary-color);">æˆé•·ã®èƒŒæ¯”ã¹</h3>
                <p style="font-size: 0.9rem; color: var(--text-sub);">å‹•ç‰©ãŸã¡ã¨ã®æ™‚é–“ã¯ã€ã‚ã£ã¨ã„ã†é–“ã«éãã¦ã„ãã¾ã™ã€‚<br>ä»Šã“ã®ç¬é–“ã‚’å¤§åˆ‡ã«ã€‚</p>
            </div>
        </div>
    </main>

    <script>
        async function calculateAge() {
            const type = document.getElementById('animal-type').value;
            const years = parseInt(document.getElementById('animal-age-years').value) || 0;
            const months = parseInt(document.getElementById('animal-age-months').value) || 0;

            if (years === 0 && months === 0) {
                alert("å¹´é½¢ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
                return;
            }

            try {
                const response = await fetch('/api/retriever/calculate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        animal_type: type,
                        age_years: years,
                        age_months: months
                    })
                });

                if (!response.ok) {
                    throw new Error("API Request Failed");
                }

                const data = await response.json();
                displayResult(data);

            } catch (error) {
                console.error(error);
                alert("ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚");
            }
        }

        function displayResult(data) {
            document.getElementById('result-section').style.display = 'block';

            // Counter Animation
            animateValue("human-age-num", 0, data.human_age, 1000);

            document.getElementById('result-stage').textContent = data.stage;
            document.getElementById('advice-title').textContent = data.advice.title;
            document.getElementById('advice-text').textContent = data.advice.care;
            document.getElementById('checkup-text').textContent = data.advice.checkup;

            // Chart
            // Assume 100 is max sensible human age for bar
            const percentage = Math.min(data.human_age, 100);
            document.getElementById('life-bar').style.width = percentage + "%";

            // Scroll to result
            document.getElementById('result-section').scrollIntoView({ behavior: 'smooth' });

            // Update Canvas Overlay Text if image exists
            if (uploadedImage) {
                drawCanvas(data.human_age);
            }

            currentHumanAge = data.human_age;
        }

        function animateValue(id, start, end, duration) {
            if (start === end) return;
            const range = end - start;
            let current = start;
            const increment = end > start ? 1 : -1;
            const stepTime = Math.abs(Math.floor(duration / range));
            const obj = document.getElementById(id);

            const timer = setInterval(function () {
                current += increment;
                obj.textContent = current;
                if (current == end) {
                    clearInterval(timer);
                }
            }, stepTime);
        }

        // Photo Handling
        let uploadedImage = null;
        let currentHumanAge = null;
        const canvas = document.getElementById('photo-canvas');
        const ctx = canvas.getContext('2d');

        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function (e) {
                const img = new Image();
                img.onload = function () {
                    uploadedImage = img;
                    canvas.width = 400; // Fixed width for display
                    canvas.height = img.height * (400 / img.width);
                    drawCanvas(currentHumanAge);
                }
                img.src = e.target.result;
            }
            reader.readAsDataURL(file);
        }

        function drawCanvas(age) {
            if (!uploadedImage) return;

            // Draw Image
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(uploadedImage, 0, 0, canvas.width, canvas.height);

            // Draw Overlay (Stamp)
            if (age !== null) {
                ctx.fillStyle = "rgba(255, 255, 255, 0.8)";
                ctx.strokeStyle = "#8D6E63";
                ctx.lineWidth = 3;

                // Badge style
                const badgeW = 120;
                const badgeH = 120;
                const badgeX = canvas.width - badgeW - 10;
                const badgeY = canvas.height - badgeH - 10;

                ctx.beginPath();
                ctx.arc(badgeX + badgeW / 2, badgeY + badgeH / 2, badgeW / 2, 0, Math.PI * 2);
                ctx.fill();
                ctx.stroke();

                ctx.fillStyle = "#3E2723";
                ctx.font = "bold 20px 'Noto Sans JP'";
                ctx.textAlign = "center";
                ctx.fillText("äººé–“å¹´é½¢", badgeX + badgeW / 2, badgeY + badgeH / 2 - 10);

                ctx.font = "bold 40px 'Outfit'";
                ctx.fillStyle = "#FF7043";
                ctx.fillText(age + "æ­³", badgeX + badgeW / 2, badgeY + badgeH / 2 + 30);
            }
        }
    </script>

</body>

</html>